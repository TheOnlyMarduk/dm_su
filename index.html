<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Laufstrecken</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { height: 100vh; width: 100vw; }
  .arrow-icon { font-size: 20px; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; pointer-events: none; }
  .arrow-symbol { display: inline-block; transform-origin: center; }
  .marker-label { background: white; border: 2px solid black; border-radius: 50%; text-align: center; font-weight: bold; color: black; box-shadow: 0 0 3px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
  .km-label { background: yellow; border: 1px solid black; border-radius: 3px; padding: 2px 5px; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center; white-space: nowrap; }
</style>
</head>
<body>
<div id="map"></div>

<script>
const map = L.map('map');

// OpenStreetMap-Kachel-Layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

// Layer-Gruppen für alle Läufe, Parkplätze und ÖPNV
const layer10km = L.layerGroup();
const layer5km = L.layerGroup();
const layerSchuelerlauf = L.layerGroup();
const layerKinderlauf = L.layerGroup();
const layerBambinilauf = L.layerGroup();
const parkingLayer = L.layerGroup();
const oepnvLayer = L.layerGroup();

let startMarker10km, goalMarker10km;
let startMarker5km, goalMarker5km;
let startMarkerSchueler, goalMarkerSchueler;
let startMarkerKinderlauf, goalMarkerKinderlauf;
let startMarkerBambinilauf, goalMarkerBambinilauf;

// Funktion für skalierte Marker-Beschriftungen abhängig vom Zoomlevel
function createScaledMarkerLabel(text, baseSize, color = 'black') {
  const zoom = map.getZoom();
  const scale = Math.min(1, Math.max(0.6, (zoom - 12) / 6));
  const size = baseSize * scale;
  return `<div class="marker-label" style="width:${size}px;height:${size}px;font-size:${size*0.45}px;color:${color};border-color:${color};">${text}</div>`;
}

// (Deine bestehenden Funktionen hier unverändert ...)

// Parkplätze laden und darstellen (wie gehabt)
function loadAndDrawParking() {
  fetch('parken.geojson')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(feature => {
        if (!feature.geometry || feature.geometry.type !== 'Point') return;
        const coords = feature.geometry.coordinates;
        const latlng = L.latLng(coords[1], coords[0]);
        const adresse = feature.properties.adresse || "Parkplatz";
        const parkIcon = () => L.divIcon({ className: "start-goal-icon", iconAnchor: [15,15], html: createScaledMarkerLabel("P", 30) });
        const marker = L.marker(latlng, { icon: parkIcon() }).addTo(parkingLayer);
        marker.bindTooltip(adresse, { permanent: false, direction: 'top' });
        map.on('zoomend', () => marker.setIcon(parkIcon()));
      });
      parkingLayer.addTo(map);
    })
    .catch(err => console.error("Fehler beim Laden der parken.geojson:", err));
}

// NEU: ÖPNV laden und darstellen mit H-Marker, Skalierung und Tooltip aus info-Spalte
function loadAndDrawOepnv() {
  fetch('oepnv.geojson')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(feature => {
        if (!feature.geometry || feature.geometry.type !== 'Point') return;
        const coords = feature.geometry.coordinates;
        const latlng = L.latLng(coords[1], coords[0]);
        const infoText = feature.properties.info || "ÖPNV Haltestelle";

        const hIcon = () => L.divIcon({
          className: "start-goal-icon",
          iconAnchor: [15,15],
          html: createScaledMarkerLabel("H", 30, 'darkblue')
        });

        const marker = L.marker(latlng, { icon: hIcon() }).addTo(oepnvLayer);
        marker.bindTooltip(infoText, { permanent: false, direction: 'top' });

        map.on('zoomend', () => marker.setIcon(hIcon()));
      });
      oepnvLayer.addTo(map);
    })
    .catch(err => console.error("Fehler beim Laden der oepnv.geojson:", err));
}

// (Deine bestehenden Läufe laden, unverändert ...)

// Läufe laden (10km als Beispiel hier)
fetch('10km.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, { style: { color: 'blue', weight: 4 } }).addTo(layer10km);
    map.fitBounds(L.geoJSON(data).getBounds(), { padding: [20,20] });
    // (Rest siehe dein bestehender Code)
    // ...
  });

// Parkplätze laden
loadAndDrawParking();

// ÖPNV laden (neu)
loadAndDrawOepnv();

// Layer Control mit Basis-Layern und Overlays
const baseLayers = {
  "10 km DM und Citylauf (2 Runden)": layer10km,
  "5 km Citylauf": layer5km,
  "3,6 km KSK Köln - Schülerlauf (U14/U16)": layerSchuelerlauf,
  "1,2 km KSK Köln - Kinderlauf (U10/U12) (2 Runden)": layerKinderlauf,
  "0,6 km KSK Köln - Bambinilauf (U8)": layerBambinilauf
};

const overlays = {
  "Parkplätze": parkingLayer,
  "ÖPNV": oepnvLayer
};

// 10 km Lauf, Parkplätze und ÖPNV standardmäßig anzeigen
layer10km.addTo(map);
parkingLayer.addTo(map);
oepnvLayer.addTo(map);

L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

</script>
</body>
</html>
