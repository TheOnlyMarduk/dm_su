<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>DM SU Strecken</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { width: 100%; height: 100vh; }
  .start-goal-icon { font-weight: bold; text-align: center; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// === Karte ===
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// === Layer ===
const layer10km = L.layerGroup();
const layer5km = L.layerGroup();
const parkingLayer = L.layerGroup();

// Marker-Variablen
let startMarker10km, goalMarker10km;
let startMarker5km, goalMarker5km;

// === Nur ein Streckenlayer aktiv ===
function showOnly(layer) {
  [layer10km, layer5km].forEach(l => {
    if (l !== layer) map.removeLayer(l);
  });
  if (!map.hasLayer(layer)) layer.addTo(map);
}

// === Markerlabel erstellen ===
function createScaledMarkerLabel(text, size, color) {
  return `<div style="
    background: ${color};
    color: black;
    border: 1px solid black;
    border-radius: 5px;
    padding: 2px;
    font-weight: bold;
    font-size: ${size}px;
    display: inline-block;
  ">${text}</div>`;
}

// === Start/Ziel Marker 10km ===
function addStartAndGoalMarkers10km(geojson) {
  if (!geojson.features || geojson.features.length === 0) return;
  const coords = geojson.features[0].geometry.coordinates;
  const startLatLng = L.latLng(coords[0][1], coords[0][0]);
  const goalLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

  const startIcon = () => L.divIcon({ className: "start-goal-icon", iconAnchor: [15, 15], html: createScaledMarkerLabel("10k", 20, 'lightblue') });
  const goalIcon  = () => L.divIcon({ className: "start-goal-icon", iconAnchor: [15, 15], html: createScaledMarkerLabel("Ziel", 20, 'lightblue') });

  startMarker10km = L.marker(startLatLng, { icon: startIcon() }).addTo(layer10km);
  goalMarker10km  = L.marker(goalLatLng,  { icon: goalIcon()  }).addTo(layer10km);

  map.on('zoomend', () => {
    startMarker10km.setIcon(startIcon());
    goalMarker10km.setIcon(goalIcon());
  });
}

// === Start/Ziel Marker 5km ===
function addStartAndGoalMarkers5km(geojson) {
  if (!geojson.features || geojson.features.length === 0) return;
  const coords = geojson.features[0].geometry.coordinates;
  const startLatLng = L.latLng(coords[0][1], coords[0][0]);
  const goalLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

  const startIcon = () => L.divIcon({ className: "start-goal-icon", iconAnchor: [15, 15], html: createScaledMarkerLabel("5k", 20, 'lightcoral') });
  const goalIcon  = () => L.divIcon({ className: "start-goal-icon", iconAnchor: [15, 15], html: createScaledMarkerLabel("Ziel", 20, 'lightcoral') });

  startMarker5km = L.marker(startLatLng, { icon: startIcon() }).addTo(layer5km);
  goalMarker5km  = L.marker(goalLatLng,  { icon: goalIcon()  }).addTo(layer5km);

  map.on('zoomend', () => {
    startMarker5km.setIcon(startIcon());
    goalMarker5km.setIcon(goalIcon());
  });
}

// === Parkplätze ===
function loadAndDrawParking() {
  fetch('parken.geojson')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(f => {
        if (!f.geometry || f.geometry.type !== 'Point') return;
        const coords = f.geometry.coordinates;
        const adresse = f.properties.adresse || "Parkplatz";
        const marker = L.marker([coords[1], coords[0]]).bindTooltip(adresse);
        parkingLayer.addLayer(marker);
      });
    });
}

// === Daten laden ===
// 10 km
fetch('10km.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, { color: 'blue', weight: 4 }).addTo(layer10km);
    addStartAndGoalMarkers10km(data);
    layer10km.addTo(map); // Start: 10 km sichtbar
    map.fitBounds(L.geoJSON(data).getBounds(), { padding: [20, 20] });
  });

// 5 km
fetch('5km.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, { color: 'red', weight: 4 }).addTo(layer5km);
    addStartAndGoalMarkers5km(data);
  });

// Parkplätze laden
loadAndDrawParking();

// === Layer-Kontrolle ===
const overlays = {
  "10 km Strecke": layer10km,
  "5 km Strecke": layer5km,
  "Parkplätze": parkingLayer
};
L.control.layers(null, overlays, { collapsed: false }).addTo(map);

// === Klicklogik für nur-ein-Layer ===
map.on('overlayadd', function(e) {
  if (e.layer !== parkingLayer) showOnly(e.layer);
});
</script>
</body>
</html>
