<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>10 km Laufstrecke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PolylineDecorator 1.7.1 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.polylineDecorator/1.7.1/leaflet.polylineDecorator.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map("map");

    // Hintergrundkarte
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(map);

    // Zentrale Linienfarbe
    const lineColor = "blue";

    // Layer für 10km Strecke
    const layer10km = L.geoJSON(null, {
      style: { color: lineColor, weight: 4 },
    });

    // Pfeile aus richtung.geojson zeichnen
    function drawArrowSymbolsFromGeoJSON(geojson) {
      geojson.features.forEach((feature) => {
        const coords = feature.geometry.coordinates.map((c) =>
          L.latLng(c[1], c[0])
        );
        if (coords.length < 2) return;

        const angleProp = feature.properties.angle;
        // Richtung anpassen (angle + 180° modulo 360)
        const rotationAngle = (angleProp + 180) % 360;

        // Linie ohne Pfeile (transparent)
        const invisibleLine = L.polyline(coords, {
          color: "transparent",
          weight: 8,
        }).addTo(map);

        const arrowSymbol = L.Symbol.arrowHead({
          pixelSize: 15,
          polygon: true,
          pathOptions: { color: lineColor, fillOpacity: 1, weight: 1 },
          // rotationAngle: rotationAngle,
        });

        // Eigene Methode, um Pfeil als Marker mit Rotation an jedem Punkt zu setzen
        const arrowMarker = L.marker(coords[0], {
          icon: L.divIcon({ className: "arrow-icon" }),
          rotationAngle: rotationAngle,
        });

        // Statt Marker hier nutzen wir PolylineDecorator mit Pattern an jeder Linie
        const decorator = L.polylineDecorator(invisibleLine, {
          patterns: [
            {
              offset: 0,
              repeat: 200 + "m",
              symbol: L.Symbol.arrowHead({
                pixelSize: 15,
                polygon: true,
                pathOptions: { color: lineColor, fillOpacity: 1, weight: 1 },
                rotationAngle: rotationAngle,
              }),
            },
          ],
        });
        decorator.addTo(map);
      });
    }

    // Start- und Zielmarker setzen
  function addStartAndGoalMarkers(geojson) {
  if (!geojson.features.length) return;

  // Feature aus 10km.geojson - wir nehmen an, dass es ein LineString ist
  const feature = geojson.features[0];
  let coords;

  // Je nach Geometrie-Typ:
  if (feature.geometry.type === "LineString") {
    coords = feature.geometry.coordinates;
  } else if (feature.geometry.type === "MultiLineString") {
    // Für MultiLineString nehmen wir alle Koordinaten der ersten Linie
    coords = feature.geometry.coordinates[0];
  } else {
    console.error("Unbekannter Geometrie-Typ für Start/Ziel");
    return;
  }

  // Erster Punkt der Strecke (Start)
  const startCoords = coords[0];
  const startLatLng = L.latLng(startCoords[1] + 0.0003, startCoords[0]); // leicht nach Norden verschoben

  const startIcon = L.divIcon({
    className: "start-goal-icon",
    html: `<div style="
      background: white;
      border: 2px solid black;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      color: black;
      ">10k</div>`,
    iconAnchor: [15, 15],
    interactive: false,
  });

  L.marker(startLatLng, { icon: startIcon, interactive: false }).addTo(map);

  // Letzter Punkt der Strecke (Ziel)
  const lastCoords = coords[coords.length - 1];
  const goalLatLng = L.latLng(lastCoords[1], lastCoords[0]);

  const goalIcon = L.divIcon({
    className: "start-goal-icon",
    html: `<div style="
      background: white;
      border: 2px solid black;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      color: black;
      ">Ziel</div>`,
    iconAnchor: [15, 15],
    interactive: false,
  });

  L.marker(goalLatLng, { icon: goalIcon, interactive: false }).addTo(map);
}

    // GeoJSON laden und Karte aufbauen
    Promise.all([
      fetch("10km.geojson").then((res) => res.json()),
      fetch("richtung.geojson").then((res) => res.json()),
    ])
      .then(([tenKmData, richtungData]) => {
        layer10km.addData(tenKmData).addTo(map);
        map.fitBounds(layer10km.getBounds(), { padding: [20, 20] });

        drawArrowSymbolsFromGeoJSON(richtungData);
        addStartAndGoalMarkers(tenKmData);
      })
      .catch((err) =>
        console.error("Fehler beim Laden der GeoJSON-Datei:", err)
      );
  </script>
</body>
</html>
