<script>
// === Karte initialisieren ===
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// === Layer definieren ===
const layer10km = L.layerGroup();
const layer5km = L.layerGroup();
const layerSchueler = L.layerGroup();
const layerKinder = L.layerGroup();
const layerBambini = L.layerGroup();
const parkingLayer = L.layerGroup();

// === Start/Ziel Marker Variablen ===
let startMarker10km, goalMarker10km;
let startMarker5km, goalMarker5km;

// === Funktion: Nur ein Streckenlayer aktiv halten ===
function showOnly(layer) {
  const allRaceLayers = [layer10km, layer5km, layerSchueler, layerKinder, layerBambini];
  allRaceLayers.forEach(l => {
    if (l !== layer) {
      map.removeLayer(l);
    }
  });
  if (!map.hasLayer(layer)) {
    layer.addTo(map);
  }
}

// === Start- und Zielmarker 10km ===
function addStartAndGoalMarkers10km(geojson) {
  if (!geojson.features || geojson.features.length === 0) return;
  const coords = geojson.features[0].geometry.coordinates;
  const startLatLng = L.latLng(coords[0][1], coords[0][0]);
  const goalLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

  const startIcon = () => L.divIcon({
    className: "start-goal-icon",
    iconAnchor: [15, 15],
    html: createScaledMarkerLabel("10k", 30, 'blue')
  });
  const goalIcon = () => L.divIcon({
    className: "start-goal-icon",
    iconAnchor: [15, 15],
    html: createScaledMarkerLabel("Ziel", 30, 'blue')
  });

  startMarker10km = L.marker(startLatLng, { icon: startIcon() }).addTo(layer10km);
  goalMarker10km = L.marker(goalLatLng, { icon: goalIcon() }).addTo(layer10km);

  map.on('zoomend', () => {
    if (startMarker10km) startMarker10km.setIcon(startIcon());
    if (goalMarker10km) goalMarker10km.setIcon(goalIcon());
  });
}

// === Start- und Zielmarker 5km ===
function addStartAndGoalMarkers5km(geojson) {
  if (!geojson.features || geojson.features.length === 0) return;
  const coords = geojson.features[0].geometry.coordinates;
  const startLatLng = L.latLng(coords[0][1], coords[0][0]);
  const goalLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

  const startIcon5km = () => L.divIcon({
    className: "start-goal-icon",
    iconAnchor: [15, 15],
    html: createScaledMarkerLabel("5k", 30, 'red')
  });
  const goalIcon5km = () => L.divIcon({
    className: "start-goal-icon",
    iconAnchor: [15, 15],
    html: createScaledMarkerLabel("Ziel", 30, 'red')
  });

  startMarker5km = L.marker(startLatLng, { icon: startIcon5km() }).addTo(layer5km);
  goalMarker5km = L.marker(goalLatLng, { icon: goalIcon5km() }).addTo(layer5km);

  map.on('zoomend', () => {
    if (startMarker5km) startMarker5km.setIcon(startIcon5km());
    if (goalMarker5km) goalMarker5km.setIcon(goalIcon5km());
  });
}

// === Pfeile, Kilometerpunkte, Parken Funktionen wie gehabt ===
// (Deine bisherigen loadAndDrawArrows, loadKilometerPoints, loadAndDrawParking bleiben unverändert)

// === Daten laden ===
fetch('10km.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, { color: 'blue', weight: 4 }).addTo(layer10km);
    map.fitBounds(L.geoJSON(data).getBounds(), { padding: [20, 20] });
    addStartAndGoalMarkers10km(data);
    loadAndDrawArrows('richtung.geojson', 'blue', layer10km);
    loadKilometerPoints('10km_kilometer.geojson', 'red', layer10km, false);
    layer10km.addTo(map); // Startzustand: nur 10km sichtbar
  });

// 5km
fetch('5km.geojson')
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, { color: 'red', weight: 4 }).addTo(layer5km);
    addStartAndGoalMarkers5km(data);
    loadAndDrawArrows('5km_richtung.geojson', 'red', layer5km);
    loadKilometerPoints('5km_kilometer.geojson', 'red', layer5km, true);
  });

// TODO: fetch-Blöcke für Schülerlauf, Kinderlauf, Bambinilauf hinzufügen

// Parkplätze
loadAndDrawParking();

// === Layer-Kontrolle ===
const overlays = {
  "10 km Strecke": layer10km,
  "5 km Strecke": layer5km,
  "Schülerlauf": layerSchueler,
  "Kinderlauf": layerKinder,
  "Bambinilauf": layerBambini,
  "Parkplätze": parkingLayer
};

const control = L.control.layers(null, overlays, { collapsed: false }).addTo(map);

// === Klick-Logik: Immer nur eine Strecke aktiv ===
map.on('overlayadd', function(e) {
  if (e.layer === parkingLayer) return; // Parkplätze nicht ausschalten
  showOnly(e.layer);
});
</script>
