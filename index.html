<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Laufstrecken</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<style>
  html, body { margin: 0; padding: 0; height: 100%; }
  #map { height: 100vh; width: 100vw; }
  .arrow-icon { font-size: 20px; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; pointer-events: none; }
  .arrow-symbol { display: inline-block; transform-origin: center; }
  .marker-label { 
    background: white; 
    border: 2px solid black; 
    border-radius: 50%; 
    text-align: center; 
    font-weight: bold; 
    color: black; 
    box-shadow: 0 0 3px rgba(0,0,0,0.5); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
const map = L.map('map');

// ===================== Hintergrundkarte =====================
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
  attribution: '© OpenStreetMap' 
}).addTo(map);

// ===================== Layer-Gruppen =====================
const layer10km = L.layerGroup();
const layer5km = L.layerGroup();
const layerSchuelerlauf = L.layerGroup();
const layerKinderlauf = L.layerGroup();
const layerBambinilauf = L.layerGroup();
const layerHelfer = L.layerGroup();
const layerDoping = L.layerGroup();
const layerStartunterlagen = L.layerGroup();
const layerDusche = L.layerGroup();
const layerDixi = L.layerGroup();
const parkingLayer = L.layerGroup();
const oepnvLayer = L.layerGroup();
const layerUmleitung = L.layerGroup(); // NEU

// Marker-Referenzen
let startMarker10km, goalMarker10km;

// Variable für Bounds des 10km-Layers
let bounds10km = null;

// ===================== Marker-Beschriftung skalieren =====================
function createScaledMarkerLabel(text, baseSize, color = 'black') {
  const zoom = map.getZoom();
  const scale = Math.min(1, Math.max(0.6, (zoom - 12) / 6));
  const size = baseSize * scale;
  return `<div class="marker-label" style="width:${size}px;height:${size}px;
              font-size:${size*0.45}px;color:${color};border-color:${color};">${text}</div>`;
}

// ===================== Start- und Zielmarker =====================
function addStartAndGoalMarkers(geojson, color, labelText, targetLayer) {
  if (!geojson.features || geojson.features.length === 0) return;
  const coords = geojson.features[0].geometry.coordinates;
  const startLatLng = L.latLng(coords[0][1], coords[0][0]);
  const goalLatLng = L.latLng(coords[coords.length - 1][1], coords[coords.length - 1][0]);

  const startIcon = () => L.divIcon({ iconAnchor: [15,15], html: createScaledMarkerLabel(labelText, 30, color) });
  const goalIcon = () => L.divIcon({ iconAnchor: [15,15], html: createScaledMarkerLabel("Ziel", 30, color) });

  startMarker10km = L.marker(startLatLng, { icon: startIcon() }).addTo(targetLayer);
  goalMarker10km = L.marker(goalLatLng, { icon: goalIcon() }).addTo(targetLayer);

  map.on('zoomend', () => {
    startMarker10km.setIcon(startIcon());
    goalMarker10km.setIcon(goalIcon());
  });
}

// ===================== Helfer laden =====================
function loadHelfer() {
  fetch('helfer.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (feature, latlng) => {
          const id = feature.properties.id || '';
          const color = feature.properties.color || 'red';
          const anchorX = feature.properties.anchorX ?? 15;
          const anchorY = feature.properties.anchorY ?? 15;

          const icon = L.divIcon({
            iconAnchor: [anchorX, anchorY],
            html: createScaledMarkerLabel(id, 30, color)
          });

          const tooltipText =
            `Anzahl: ${feature.properties.Anzahl || ''}<br>` +
            `Ausrüstung: ${feature.properties.Ausrüstung || ''}<br>` +
            `Aufgabe: ${feature.properties.Aufgabe || ''}<br>` +
            `Erfahrung: ${feature.properties.Erfahrung || ''}`;

          return L.marker(latlng, { icon }).bindTooltip(tooltipText, { sticky: true });
        }
      }).addTo(layerHelfer);
    });
}

// ===================== Dopingkontrolle =====================
function loadDoping() {
  fetch('doping.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip("Dopingkontrolle")
      }).addTo(layerDoping);
    });
}

// ===================== Startunterlagen =====================
function loadStart() {
  fetch('startunterlagen.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip("Startunterlagen")
      }).addTo(layerStartunterlagen);
    });
}

// ===================== Dusche =====================
function loadDusche() {
  fetch('dusche.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip("Dusche")
      }).addTo(layerDusche);
    });
}

// ===================== Dixi =====================
function loadDixi() {
  fetch('dixi.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip("Dixi")
      }).addTo(layerDixi);
    });
}

// ===================== Parkplätze =====================
function loadAndDrawParking() {
  fetch('parken.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip(f.properties.adresse || "Parkplatz")
      }).addTo(parkingLayer);
    });
}

// ===================== ÖPNV =====================
function loadAndDrawOepnv() {
  fetch('oepnv.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.marker(latlng).bindTooltip(f.properties.info || "Haltestelle")
      }).addTo(oepnvLayer);
    });
}

// ===================== Umleitung =====================
function loadUmleitung() {
  fetch('umleitung.geojson')
    .then(res => res.json())
    .then(data => {
      L.geoJSON(data, {
        style: { color: "yellow", weight: 3, dashArray: "6,4" }
      }).addTo(layerUmleitung);
    });
}

// ===================== Laufstrecken laden =====================
fetch('10km.geojson')
  .then(res => res.json())
  .then(data => {
    const gj = L.geoJSON(data, { style: { color: 'blue', weight: 4 } }).addTo(layer10km);
    bounds10km = gj.getBounds();
    map.fitBounds(bounds10km, { padding: [20,20] });
    addStartAndGoalMarkers(data, 'blue', '10k', layer10km);
  });

// Weitere Läufe (analog)
fetch('5km.geojson').then(res => res.json()).then(data => { L.geoJSON(data, { style: { color: 'red', weight: 4 } }).addTo(layer5km); });
fetch('schuelerlauf.geojson').then(res => res.json()).then(data => { L.geoJSON(data, { style: { color: 'green', weight: 4 } }).addTo(layerSchuelerlauf); });
fetch('kinderlauf.geojson').then(res => res.json()).then(data => { L.geoJSON(data, { style: { color: 'brown', weight: 4 } }).addTo(layerKinderlauf); });
fetch('bambinilauf.geojson').then(res => res.json()).then(data => { L.geoJSON(data, { style: { color: 'black', weight: 4 } }).addTo(layerBambinilauf); });

// ===================== Overlays laden =====================
loadHelfer();
loadDoping();
loadStart();
loadDusche();
loadDixi();
loadAndDrawParking();
loadAndDrawOepnv();
loadUmleitung();

// ===================== Layer-Kontrolle =====================
const baseLayers = {
  "10 km DM und Citylauf": layer10km,
  "5 km Citylauf": layer5km,
  "3,6 km Schülerlauf": layerSchuelerlauf,
  "1,2 km Kinderlauf": layerKinderlauf,
  "0,6 km Bambinilauf": layerBambinilauf
};

const overlays = {
  "Helfer": layerHelfer,
  "Dopingkontrolle": layerDoping,
  "Startunterlagen": layerStartunterlagen,
  "Dusche": layerDusche,
  "Dixi": layerDixi,
  "Parkplätze": parkingLayer,
  "ÖPNV": oepnvLayer,
  "Umleitung": layerUmleitung   // NEU ganz unten
};

layer10km.addTo(map);
layerHelfer.addTo(map);

L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

// Immer auf 10km zoomen bei Wechsel
map.on('baselayerchange', function() {
  if (bounds10km) map.fitBounds(bounds10km, { padding: [20,20] });
});
</script>
</body>
</html>
